<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhph.payment.charge.dao.PaymentRecordMapper" >
  <resultMap id="BaseResultMap" type="com.zhph.payment.charge.entity.PaymentRecord" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Feb 13 11:25:28 CST 2017.
    -->
    <id column="PRI_NUMBER" property="priNumber" jdbcType="VARCHAR" />
    <result column="TERMINAL_ID" property="terminalId" jdbcType="VARCHAR" />
    <result column="NAME" property="name" jdbcType="VARCHAR" />
    <result column="BANK_CARD" property="bankCard" jdbcType="VARCHAR" />
    <result column="TRANS_NO" property="transNo" jdbcType="VARCHAR" />
    <result column="BATCH_NO" property="batchNo" jdbcType="VARCHAR" />
    <result column="THIRD_TRANS_NO" property="thirdTransNo" jdbcType="VARCHAR" />
    <result column="THIRD_BATCH_NO" property="thirdBatchNo" jdbcType="VARCHAR" />
    <result column="TRANS_TYPE" property="transType" jdbcType="CHAR" />
    <result column="LOAN_CONTRACT_NO" property="loanContractNo" jdbcType="VARCHAR" />
    <result column="PAYMENT_CHANNEL" property="paymentChannel" jdbcType="VARCHAR" />
    <result column="BANK_CODE" property="bankCode" jdbcType="VARCHAR" />
    <result column="TRANS_AMOUNT" property="transAmount" jdbcType="DECIMAL" />
    <result column="PAYMENT_CODE" property="paymentCode" jdbcType="CHAR" />
    <result column="PAYMENT_DESC" property="paymentDesc" jdbcType="VARCHAR" />
    <result column="PAYMENT_TIME" property="paymentTime" jdbcType="TIMESTAMP" />
    <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
    <result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Feb 13 11:25:28 CST 2017.
    -->
    PRI_NUMBER, TERMINAL_ID, NAME, BANK_CARD, TRANS_NO, BATCH_NO, THIRD_TRANS_NO, THIRD_BATCH_NO, 
    TRANS_TYPE, LOAN_CONTRACT_NO, PAYMENT_CHANNEL, BANK_CODE, TRANS_AMOUNT, PAYMENT_CODE, 
    PAYMENT_DESC, PAYMENT_TIME, CREATE_TIME, UPDATE_TIME
  </sql>

  <update id="updateByPrimaryKeySelective" parameterType="com.zhph.payment.charge.entity.PaymentRecord">
    update ZH_PAYMENT_RECORD set 1=1
  </update>
  <insert id="insertByQueryState" parameterType="com.zhph.payment.charge.entity.PaymentRecord" >
    <selectKey keyProperty="priNumber" resultType="String" order="BEFORE">
      select sys_guid() from dual
    </selectKey>
    insert into ZH_PAYMENT_RECORD (PRI_NUMBER, TRANS_NO, LOAN_CONTRACT_NO,PAYMENT_CHANNEL,
    <if test="bankCode != null  and bankCode != ''">
      BANK_CODE,
    </if>
    <if test="terminalId != null and terminalId != ''">
      TERMINAL_ID,
    </if>
       TRANS_AMOUNT,PAYMENT_DESC,PAYMENT_CODE,CREATE_TIME)
    values (#{priNumber,jdbcType=VARCHAR},#{transNo,jdbcType=VARCHAR},#{loanContractNo,jdbcType=VARCHAR}, #{paymentChannel,jdbcType=VARCHAR},
    <if test="bankCode != null  and bankCode != ''">
      #{bankCode,jdbcType=VARCHAR},
    </if>
    <if test="terminalId != null  and terminalId != ''">
      #{terminalId,jdbcType=VARCHAR},
    </if>
    #{paymentCode,jdbcType=CHAR}, #{paymentDesc,jdbcType=VARCHAR}, #{paymentCode,jdbcType=CHAR} ,sysdate)
  </insert>
  <insert id="insert" parameterType="com.zhph.payment.charge.entity.PaymentRecord" >
    <selectKey keyProperty="priNumber" resultType="String" order="BEFORE">
      select sys_guid() from dual
    </selectKey>
    insert into ZH_PAYMENT_RECORD (PRI_NUMBER, TERMINAL_ID, NAME,
      BANK_CARD, TRANS_NO, BATCH_NO, 
      THIRD_TRANS_NO, THIRD_BATCH_NO, TRANS_TYPE, 
      LOAN_CONTRACT_NO, PAYMENT_CHANNEL, BANK_CODE, 
      TRANS_AMOUNT, PAYMENT_CODE, PAYMENT_DESC, 
      PAYMENT_TIME, CREATE_TIME, UPDATE_TIME
      )
    values (#{priNumber,jdbcType=VARCHAR}, #{terminalId,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR},
      #{bankCard,jdbcType=VARCHAR}, #{transNo,jdbcType=VARCHAR}, #{batchNo,jdbcType=VARCHAR}, 
      #{thirdTransNo,jdbcType=VARCHAR}, #{thirdBatchNo,jdbcType=VARCHAR}, #{transType,jdbcType=CHAR}, 
      #{loanContractNo,jdbcType=VARCHAR}, #{paymentChannel,jdbcType=VARCHAR}, #{bankCode,jdbcType=VARCHAR}, 
      #{transAmount,jdbcType=DECIMAL}, #{paymentCode,jdbcType=CHAR}, #{paymentDesc,jdbcType=VARCHAR}, 
      #{paymentTime,jdbcType=TIMESTAMP}, #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}
      )
  </insert>


  <update id="updateByPrimaryKey" parameterType="com.zhph.payment.charge.entity.PaymentRecord" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Feb 13 11:25:28 CST 2017.
    -->
    update ZH_PAYMENT_RECORD
    set TERMINAL_ID = #{terminalId,jdbcType=VARCHAR},
      NAME = #{name,jdbcType=VARCHAR},
      BANK_CARD = #{bankCard,jdbcType=VARCHAR},
      TRANS_NO = #{transNo,jdbcType=VARCHAR},
      BATCH_NO = #{batchNo,jdbcType=VARCHAR},
      THIRD_TRANS_NO = #{thirdTransNo,jdbcType=VARCHAR},
      THIRD_BATCH_NO = #{thirdBatchNo,jdbcType=VARCHAR},
      TRANS_TYPE = #{transType,jdbcType=CHAR},
      LOAN_CONTRACT_NO = #{loanContractNo,jdbcType=VARCHAR},
      PAYMENT_CHANNEL = #{paymentChannel,jdbcType=VARCHAR},
      BANK_CODE = #{bankCode,jdbcType=VARCHAR},
      TRANS_AMOUNT = #{transAmount,jdbcType=DECIMAL},
      PAYMENT_CODE = #{paymentCode,jdbcType=CHAR},
      PAYMENT_DESC = #{paymentDesc,jdbcType=VARCHAR},
      PAYMENT_TIME = #{paymentTime,jdbcType=TIMESTAMP},
      CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
      UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP}
    where PRI_NUMBER = #{priNumber,jdbcType=VARCHAR}
  </update>

  <resultMap id="paymentMap" type="java.util.HashMap">
    <result column="financing_channel" property="paymentChannel"></result>
    <result column="paymentNum" property="paymentNum"></result>
  </resultMap>
  <select id="queryPaymentNum" resultMap="paymentMap">
    select l.financing_channel,count(1) paymentNum
    from zh_payment_record r
    join zh_bank_normal_limit l on r.payment_channel = l.financing_channel and l.is_enable = '1'
    where
	r.loan_contract_no = #{loanContractNo,jdbcType=VARCHAR} and
    to_char(r.create_time,'yyyy-MM-dd') = to_char(sysdate,'yyyy-MM-dd') and 
     r.payment_code = '3'
    and l.bank_key = #{bankKey,jdbcType=VARCHAR}
    and l.main_body = #{mainbody,jdbcType=VARCHAR}
    group by l.financing_channel
  </select>



  <select id="sumTotalPaymentAmount" resultType="java.lang.Double">
    select nvl(sum(r.trans_amount),0)
    from zh_payment_record r
    where r.loan_contract_no = #{loanContractNo,jdbcType=VARCHAR}
    and r.payment_channel = #{paymentChannel,jdbcType=VARCHAR}
    and to_char(r.create_time,'yyyy-MM-dd') = to_char(sysdate,'yyyy-MM-dd')
    and r.trans_type = '1'
    and r.payment_code != '3'
  </select>


</mapper>